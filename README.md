# AWS Cloudtrail Workshop 2021:
This small workshop walks a customer through the ability to alert on specific events that AWS CloudTrail records and then evaluate and respond to these in three ways:
1. Capture AWS Resource *Change* through AWS EventBridge and notify via AWS SNS Email Notification
2. Capture AWS Resource *State* through AWS Config and remediate via AWS Systems Manager Document
3. Capture AWS Resource *History* through Amazon S3, query this information via Amazon Athena and visualize the data in a dashboard using Amazon QuickSight.

## Architectural Diagram:
![Architectural Diagram](/cloudtrail-workshop-2021.jpg)

## Steps to follow: 
1. Go into AWS IAM Console and create 3 AWS IAM Roles, call them:
    - `Authorized`, this role will have `s3-full-access` managed policy attached to it. Mark the `ARN` of this role in a notepad, you will use it later. (Typically, we would use much less permisive policy for S3 here)
    - `Unauthorized`, this role will have `s3-read-only` managed policy attached to it. Mark the `ARN` of this role in a notepad, you will use it later.
    - `MyConfigRole`, this role will have `AWSConfigRole` and `AmazonSNSFullAccess` managed policies attached to it. Mark the `ARN` of this role in a notepad, you will use it later. (Typically, we would use much less permisive policy for SNS here, [inspiration here](https://docs.aws.amazon.com/config/latest/developerguide/iamrole-permissions.html))
2. Create a Amazon S3 bucket and call it with unique name, for example `my-monitored-bucket-4839dna94`. Mark the `ARN` of this bucket in a notepad, you will use it later. When creating this bucket, set-up `Default Encryption` as `Enabled` and use the value `AWS Key Management Service key (SSE-KMS)` <details>![S3 Bucket Encryption Configuration](/step2.png)</details>
3. Create an Amazon SNS topic called `EncryptionDisabled` and set it to be `Standard` <details>![SNS Topic Configuration](/step3.png)</details>
4. Create a Amazon SNS Subscription of type `Email` and your email address, where you want to be receiving notifications. Once you create this subscription, head over to your email and confirm it, until you confirm it, no notifications will be sent there. <details>![SNS Subscription Configuration](/step4.png)</details>
5. Create an EventBridge Rule called `EncryptionDisabled`, set it to `Event Pattern`, then to `Pre-defined patern by service`, later select Service provier as `AWS`, Service name as `Simple Storage Service (S3)`, Event type to `Bucket Level Operations` and finally to a Specific operation(s) of `DeleteBucketEncryption`. As a target of this rule, we select `SNS Topic` and we pick the topic created in the previous step from the dropdown. <details>![EventBridge Rule Configuration](/step5.png)</details>
6. Open AWS Config Console. If you open AWS Config for the fist time, click on `1-click set-up`. Then click on `Rules` and `Add Rule`. In the wizard, search for `s3-default-encryption-kms` from AWS Managed Rules. Click Next. On the next screen, name sure to set Resource Identifier to only specific bucket name that you created in the step 2. Once the rule is done, click on Rule `Actions` and `Re-evaluate`. This should yield `Compliant` status as this particular bucket is encrypted. <details>![Config Rule Configuration](/step6.png)</details> 
7. Navigate to AWS Systems Manager Service, in the left menu, click on `Documents` tab. Next-up, click on `Create Document` dropdown and pick `Automation` document option. You can choose a name for your document, but we can use `My-EnableS3BucketEncryption` (Notice, there is also a Document, called `AWS-EnableS3BucketEncryption`, created by AWS, but this Document cannot accept the specific KMS Key we want to use to encrypt our bucket). We could use `Builder` to create this document step-by-step, instead, we can use `Editor` tab, where we click on edit and paste content of the attached [ssm.json](/ssm.json) file. Finally, we click on `Create automation` button.
8. Now we will retrieve the key from `AWS Key Management Service`. After navigating to the service, we click on `AWS managed keys` in the left panel and note `Key ID` parameter for aws/s3 Alias. It will be in the format like this: 	`9876zyx-0000-1234-5678-aaabbbcccddd`.
9. In AWS Config Console, click on `Rules` in the left panel, then click on `s3-default-encryption-kms` Rule we created in the step 6. Once we are in the detail screen of the AWS COnfig RUle, click on `Actions` in top right and pick `Manage remediation` from the dropdown. Pick `Manual remediation` first and as pick `My-EnableS3BucketEncryption` from the dropdown. As Resource ID parameter, pick `BucketName`, change the parameter of `SSEAlgotithm` to `aws:kms` and the parameter `KMSKeyID` to Key ID retrieved in the Step 7. <details>![Config Rule Remediation Configuration](/step8.png)</details>
10. Open AWS CloudShell Console. Now you will try to assume the `Unauthorized` role by execuriting this command: `eval $(aws sts assume-role --role-arn ARN --role-session-name unauthorizedRole | jq -r '.Credentials | "export AWS_ACCESS_KEY_ID=\(.AccessKeyId)\nexport AWS_SECRET_ACCESS_KEY=\(.SecretAccessKey)\nexport AWS_SESSION_TOKEN=\(.SessionToken)\n"')`
    - once this role is assumed, let's verify the `assume-role` call by calling `aws sts get-caller-identity`, we should observe that now we act as unauthorized role we created. 
    - now, we will try to turn-off the encryption on the S3 bucket, let's try running  `aws s3 delete-bucket-encryption --bucket my-monitored-bucket-?????????`
    - what has happened? are we notified? can we see any change on our AWS Config Dashboard?
11. Now you will try to assume the `Authorized` role by execuriting this command: `eval $(aws sts assume-role --role-arn ARN --role-session-name unauthorizedRole | jq -r '.Credentials | "export AWS_ACCESS_KEY_ID=\(.AccessKeyId)\nexport AWS_SECRET_ACCESS_KEY=\(.SecretAccessKey)\nexport AWS_SESSION_TOKEN=\(.SessionToken)\n"')`
    - once this role is assumed, let's verify the `assume-role` call by calling `aws sts get-caller-identity`, we should observe that now we act as unauthorized role we created. 
    - now, we will try to turn-off the encryption on the S3 bucket, let's try running  `aws s3 delete-bucket-encryption --bucket my-monitored-bucket-?????????`
    - what has happened? are we notified? can we see any change on our AWS Config Dashboard?
12. In the previous step, we caused the Amazon S3 Bucket to be non-compliant. We can now test the AWS Config Remediation we have created in the Step 9. Navigate to AWS Config Console, click on `Rules` in the left menu, then click on the AWS Config Rule created called `s3-default-encryption-kms`. Once in the detail page, notice section called `Resources in scope`, select the Amazon S3 Bucket you want to remediate by clicking on the radio button on the left next to it and then click on orange `Remediate` button. Observe, that after the remediation is done, the resource will become compliant. <details>![Config Rule Remediation Trigger](/step12.png)</details>
    - In this short exercise (the Step 12), we have tested different ways to observe *State* and *Change* on a resource, in this case we tested enabling/disabling encryption on a Amazon S3 bucket. In the last part of this workshop, we will query and visualize historical data about the *State* and *Change* of the resource watched.
13. Create another Amazon S3 Bucket and call it with unique name, for example `my-cloudtrail-archive-bucket-4839dna94`. Mark the `ARN` of this bucket in a notepad, you will use it later.
14. AWS CloudTrail can store all *Change*s and *State*s of all resources into another Amazon S3 Bucket. We will set this up by going to the AWS CloudTrail Cnsole and creating a new trail. On the left panel, click on `Create Trail` and pick `S3` option. Then, set the name of the trail to `my-cloudtrail-archive-trail` and pick the bucket you created in the previous step. Then, click on `Create Trail` button.
15. Return to AWS CloudShell Console and run `aws s3 delete-bucket-encryption --bucket my-monitored-bucket-?????????`

## Shortcut
Deploy this entire architecture through [AWS CloudFormation Template](/template.yaml). This is currently WIP (Work-In-Progress)